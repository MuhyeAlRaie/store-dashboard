<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة تحكم المتجر</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .table-responsive { max-height: 400px; overflow-y: auto; }
    .section { margin-bottom: 60px; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
    #product-message {
  font-weight: bold;
  text-align: center;
  font-size: 1rem;
  z-index: 9999;
}
  </style>
</head>
<body class="p-4">

<div id="loginBox" style="max-width: 300px; margin: 100px auto;">
  <h5 class="text-center mb-3">🔐 تسجيل الدخول</h5>
  <input type="text" id="adminUsername" placeholder="اسم المستخدم" class="form-control mb-2">
  <input type="password" id="adminPassword" placeholder="كلمة المرور" class="form-control mb-2">
  <button onclick="verifyLogin()" class="btn btn-primary w-100">دخول</button>
  <div id="loginError" class="text-danger mt-2 text-center"></div>
</div>

<div id="dashboardContent" style="display:none;">
  <!-- لوحة التحكم الكاملة هنا -->
   <button onclick="logout()" class="btn btn-outline-danger btn-sm">🚪 تسجيل الخروج</button>

<script>
  function logout() {
    localStorage.removeItem("dashboard-auth");
    location.reload();
  }
</script>
    <div class="container">
    <h2 class="mb-4">🛒 لوحة تحكم المتجر</h2>

    <!-- قسم عرض وإدارة المنتجات -->
    <div class="section">
      <h4 class="mb-3">📦 إدارة المنتجات</h4>
      <div class="row">
        <div class="col-lg-8">
          <div class="table-responsive mb-4">
            <table class="table table-bordered table-striped" id="productsTable">
              <thead class="table-light">
                <tr>
                  <th>الاسم</th>
                  <th>السعر</th>
                  <th>السعر السابق</th>
                  <th>التصنيف</th>
                  <th>الوصف المختصر</th>
                  <th>متوفر</th>
                  <th>تعديل</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="col-lg-4">
          <h6 class="mb-3">✏️ تعديل / إضافة منتج</h6>
          <form id="productForm">
            <input type="hidden" id="product-id">
            <div class="mb-2"><input class="form-control" id="product-name" placeholder="اسم المنتج"></div>
            <div class="mb-2"><input class="form-control" id="product-price" placeholder="السعر"></div>
            <div class="mb-2"><input class="form-control" id="product-oldPrice" placeholder="السعر السابق"></div>
            <div class="mb-2"><input class="form-control" id="product-category" placeholder="التصنيف"></div>
            <div class="mb-2"><input class="form-control" id="product-shortDesc" placeholder="الوصف المختصر"></div>
            <div class="mb-2"><input class="form-control" id="product-description" placeholder="الوصف الكامل"></div>
            <div class="mb-2"><input class="form-control" id="product-colors" placeholder="الألوان (مفصولة بفاصلة)"></div>
            <div class="mb-3">
  <label for="product-image-file" class="form-label">📷 صور المنتج</label>
  <input type="file" id="product-image-file" class="form-control mb-2" multiple accept="image/*">
  <input type="hidden" id="product-images">
  <div id="upload-status" class="text-muted small"></div>
</div>
            <div class="mb-2"><input class="form-control" id="product-available" placeholder="متوفر؟ yes/no"></div>
            <button class="btn btn-success w-100" type="submit">💾 حفظ المنتج</button>
            <div id="product-message" class="alert alert-success mt-3" role="alert" style="display: none;"></div>

          </form>
        </div>
      </div>
    </div>

    <!-- قسم عرض الطلبات -->
    <div class="section">
      <h4 class="mb-3">🧾 الطلبات</h4>
<div class="mb-3">
  <input type="text" id="searchOrdersInput" class="form-control" placeholder="🔍 ابحث بالاسم أو التاريخ..." oninput="filterOrders()">
</div>
      <div class="table-responsive">
        <table class="table table-bordered table-striped" id="ordersTable">
          <thead class="table-light">
            <tr>
              <th>الاسم</th>
              <th>الهاتف</th>
              <th>المنطقة</th>
              <th>العنوان</th>
              <th>الدفع</th>
              <th>المنتجات</th>
              <th>رسوم التوصيل</th>
              <th>الخصم</th>
              <th>كوبون</th>
              <th>الإجمالي</th>
              <th>التاريخ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

 
<script>
  const LOGIN_API = "https://script.google.com/macros/s/AKfycbyjhVoFuBThqJlBensobrcyh8hFIEGO44l_wb8MCFH1xsEJf2DnD3UMtSblUxosBi5gKg/exec"; // ← غيّر إلى رابطك

  function verifyLogin() {
    const username = document.getElementById("adminUsername").value;
    const password = document.getElementById("adminPassword").value;

    fetch(LOGIN_API, {
      method: "POST",
      body: JSON.stringify({ username, password })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        localStorage.setItem("dashboard-auth", "true");
        showDashboard();
      } else {
        document.getElementById("loginError").textContent = "❌ بيانات الدخول غير صحيحة";
      }
    })
    .catch(() => {
      document.getElementById("loginError").textContent = "⚠️ خطأ في الاتصال بالسيرفر";
    });
  }

  function showDashboard() {
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("dashboardContent").style.display = "block";
  }

  window.onload = () => {
    if (localStorage.getItem("dashboard-auth") === "true") {
      showDashboard();
    }
  };
</script>
  <script>
    const PRODUCTS_API_URL = "https://script.google.com/macros/s/AKfycbyQ1eG5EynTHOpxJNFQBVJiAU5QTX880Y-jctfM1GS1UVkpOXOFZ_SEqI1GTAQ87UUPhA/exec";
    const ORDERS_API_URL = "https://script.google.com/macros/s/AKfycbw-pT4ThTSIDbAlBfe-r2Q6rIkW9LFYRqWhLqlC8ExvJEb9l0V_WIlR--9F4ze2_ycn/exec";

    // تحميل المنتجات
    function loadProducts() { 
  fetch(PRODUCTS_API_URL)
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#productsTable tbody");
      tbody.innerHTML = '';

      data
        .filter(p => p.name && p.name.trim() !== '') // ✅ تجاهل المنتجات بدون اسم
        .forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.name}</td>
            <td>${p.price}</td>
            <td>${p.oldPrice}</td>
            <td>${p.category}</td>
            <td>${p.shortDesc}</td>
            <td>${p.available}</td>
            <td>
              <button class="btn btn-sm btn-warning me-1" onclick='editProduct(${JSON.stringify(p)})'>✎</button>
              <button class="btn btn-sm btn-danger" onclick='deleteProduct("${p.id}")'>🗑️</button>
            </td>`;
          tbody.appendChild(tr);
        });
    });
}

    function editProduct(p) {
      document.getElementById('product-id').value = p.id || '';
      document.getElementById('product-name').value = p.name || '';
      document.getElementById('product-price').value = p.price || '';
      document.getElementById('product-oldPrice').value = p.oldPrice || '';
      document.getElementById('product-category').value = p.category || '';
      document.getElementById('product-shortDesc').value = p.shortDesc || '';
      document.getElementById('product-description').value = p.description || '';
      document.getElementById('product-images').value = p.images || '';
      document.getElementById('product-colors').value = p.colors || '';
      document.getElementById('product-available').value = p.available || '';
    }

    document.getElementById("productForm").addEventListener("submit", e => {
  e.preventDefault();

  const idField = document.getElementById('product-id');
  const isEdit = !!idField.value;

  const data = {
    id: idField.value || Date.now(),
    name: document.getElementById('product-name').value,
    price: document.getElementById('product-price').value,
    oldPrice: document.getElementById('product-oldPrice').value,
    category: document.getElementById('product-category').value,
    shortDesc: document.getElementById('product-shortDesc').value,
    description: document.getElementById('product-description').value,
    available: document.getElementById('product-available').value,
    colors: document.getElementById('product-colors').value,
    images: document.getElementById('product-images').value,
  };

  fetch(PRODUCTS_API_URL, {
    method: "POST",
    body: JSON.stringify(data),
  }).then(() => {
    loadProducts();
    e.target.reset();
    idField.value = "";

    const messageEl = document.getElementById("product-message");
messageEl.textContent = isEdit
  ? "✅ تم تعديل المنتج بنجاح"
  : "✅ تم إضافة المنتج";
messageEl.className = "alert alert-success mt-3";
messageEl.style.display = "block";

setTimeout(() => {
  messageEl.style.display = "none";
}, 3000);
  }).catch(() => {
    const messageEl = document.getElementById("product-message");
    messageEl.classList.remove("alert-success");
    messageEl.classList.add("alert-danger");
    messageEl.innerHTML = "❌ فشل في الحفظ، تحقق من الاتصال";
    messageEl.style.display = "block";
  });
});



    // تحميل الطلبات
    function loadOrders() {
      fetch(ORDERS_API_URL)
        .then(res => res.json())
        .then(data => {
          const tbody = document.querySelector("#ordersTable tbody");
          tbody.innerHTML = '';
        

          data.filter(p => p.name && p.name.trim() !== '').forEach(order => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${order.name}</td>
              <td>${order.phone}</td>
              <td>${order.area}</td>
              <td>${order.address}</td>
              <td>${order.payment}</td>
              <td><pre>${order.items}</pre></td>
              <td>${order.deliveryFee}</td>
              <td>${order.discountAmount}</td>
              <td>${order.coupon}</td>
              <td>${order.total}</td>
              <td>${new Date(order.date || order.Timestamp).toLocaleString()}</td>`;
            tbody.appendChild(tr);
          });
        });
    }

    function filterOrders() {
  const keyword = document.getElementById("searchOrdersInput").value.toLowerCase();
  const rows = document.querySelectorAll("#ordersTable tbody tr");

  rows.forEach(row => {
    const name = row.cells[0].textContent.toLowerCase();     // الاسم
    const date = row.cells[10].textContent.toLowerCase();    // التاريخ

    const match = name.includes(keyword) || date.includes(keyword);
    row.style.display = match ? "" : "none";
  });
}

function deleteProduct(productId) {
  if (!confirm("❗ هل أنت متأكد أنك تريد حذف هذا المنتج؟")) return;

 fetch(PRODUCTS_API_URL + "?_method=DELETE", {
  method: "POST",
  body: JSON.stringify({ id: productId })
})
  .then(res => res.json())
  .then(res => {
    if (res.success) {
      alert("✅ تم حذف المنتج");
      loadProducts();
    } else {
      alert("❌ فشل الحذف: " + res.message);
    }
  })
  .catch(() => alert("❌ خطأ أثناء الاتصال بالحذف"));
}

    loadProducts();
    loadOrders();

    const cloudName = "dezvuqqrl"; // استبدله باسم حسابك في Cloudinary
const uploadPreset = "unsigned_preset"; // استبدله بـ unsigned preset من Cloudinary

document.getElementById('product-image-file').addEventListener('change', async function () {
  const files = this.files;
  const status = document.getElementById('upload-status');
  const imageLinks = [];

  status.textContent = '📤 جاري رفع الصور...';

  for (const file of files) {
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", uploadPreset);

    try {
      const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      if (data.secure_url) {
        imageLinks.push(data.secure_url);
      } else {
        alert("❌ فشل رفع صورة: " + file.name);
      }
    } catch (err) {
      alert("⚠️ خطأ في رفع الصورة: " + err.message);
    }
  }

  document.getElementById('product-images').value = imageLinks.join(", ");
  status.textContent = `✅ تم رفع ${imageLinks.length} صورة`;
});

  </script>
</body>
</html>
